name: CI MLflow + Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      MLFLOW_TRACKING_URI: https://dagshub.com/renal4452/Workflow-CI_Renaldy-Surya-Pratama.mlflow
      MLFLOW_TRACKING_USERNAME: renal4452
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
      DOCKER_IMAGE_NAME: bank-mlflow

    steps:
      # Checkout repo
      - uses: actions/checkout@v4

      # Setup Python
      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: "3.12.7"

      # Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.19.0 dagshub==0.3.15 pandas scikit-learn numpy matplotlib seaborn

      # Run MLflow project
      - name: Run MLflow project
        run: |
          mlflow run . --env-manager=local --experiment-name bank-deposit-tuning

      # Ambil latest run_id dari DAGsHub
      - name: Get latest MLflow run_id from DAGsHub
        run: |
          python - <<EOF
          import mlflow

          mlflow.set_tracking_uri("${{ env.MLFLOW_TRACKING_URI }}")
          client = mlflow.tracking.MlflowClient(
              tracking_uri="${{ env.MLFLOW_TRACKING_URI }}"
          )

          experiment = client.get_experiment_by_name("bank-deposit-tuning")
          if experiment is None:
              raise ValueError("Experiment not found on DAGsHub.")

          runs = client.search_runs(
              experiment_ids=[experiment.experiment_id],
              order_by=["start_time DESC"],
              max_results=1
          )
          if not runs:
              raise ValueError("No runs found in experiment.")

          run_id = runs[0].info.run_id
          print(f"RUN_ID={run_id}")

          with open("${GITHUB_ENV}", "a") as f:
              f.write(f"RUN_ID={run_id}\n")
          EOF

      # Download MLflow artifacts   
      - name: Download MLflow artifacts
        run: |
          ARTEFAK_DIR=artefak
          mkdir -p "$ARTEFAK_DIR"
          mlflow artifacts download \
            -r ${{ env.MLFLOW_TRACKING_URI }} \
            -u runs:/$RUN_ID/model \
            -d "$ARTEFAK_DIR/model"

      # Commit artefak ke repo
      - name: Commit MLflow artifacts to repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add artefak/
          git commit -m "Add MLflow artifacts for run $RUN_ID" || echo "No changes to commit"
          git push https://$MY_TOKEN@github.com/renal4452/Workflow-CI_Renaldy-Surya-Pratama.git HEAD:main
        env:
          RUN_ID: ${{ env.RUN_ID }}
          MY_TOKEN: ${{ secrets.MY_TOKEN }}

      # Login ke Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build Docker image dari model MLflow
      - name: Build Docker image
        run: |
          mlflow models build-docker \
            -m runs:/$RUN_ID/model \
            -n ${{ env.DOCKER_IMAGE_NAME }}

      # Tag Docker image
      - name: Tag Docker image
        run: |
          docker tag ${{ env.DOCKER_IMAGE_NAME }} ${{ secrets.DOCKERHUB_USER }}/$DOCKER_IMAGE_NAME:latest

      # Push Docker image ke Docker Hub
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USER }}/$DOCKER_IMAGE_NAME:latest
