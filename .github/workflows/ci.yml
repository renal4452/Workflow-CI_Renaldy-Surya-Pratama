name: MLflow CI Training + Docker

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train-and-dockerize:
    runs-on: ubuntu-latest

    env:
      MLFLOW_TRACKING_URI: https://dagshub.com/renal4452/Workflow-CI_Renaldy-Surya-Pratama.mlflow
      MLFLOW_TRACKING_USERNAME: renal4452
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}

    steps:
    # =========================
    # CHECKOUT
    # =========================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =========================
    # PYTHON
    # =========================
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
         python-version: "3.12.7"

    # =========================
    # INSTALL DEPENDENCIES
    # =========================
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install \
          mlflow==2.19.0 \
          pandas \
          scikit-learn \
          numpy \
          matplotlib \
          seaborn

    # =========================
    # RUN MLFLOW PROJECT
    # =========================
    - name: Run MLflow Project
      run: |
        mlflow run . --env-manager=local --experiment-name bank-deposit-tuning
    
    # =========================
    # GET LATEST RUN_ID
    # =========================
    - name: Get latest MLflow run_id from DAGsHub
      run: |
        # Install jq untuk parsing JSON
        sudo apt-get update && sudo apt-get install -y jq

        # Ambil run terbaru dari eksperimen bank-deposit-tuning
        RUN_ID=$(mlflow search-runs \
          --experiment-names "bank-deposit-tuning" \
          --order-by "start_time desc" \
          --max-results 1 \
          --output-format json | jq -r '.[0].run_id')

        if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
          echo "No MLflow runs found on DAGsHub. Please check your experiment name or if a run exists."
          exit 1
        fi

        echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
        echo "Latest MLflow run_id from DAGsHub: $RUN_ID"
      env:
        MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
        MLFLOW_TRACKING_USERNAME: ${{ env.MLFLOW_TRACKING_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ env.MLFLOW_TRACKING_PASSWORD }}

    # =========================
    # LOGIN DOCKER HUB
    # =========================
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # =========================
    # BUILD DOCKER FROM MODEL
    # =========================
    - name: Build Docker image from MLflow model
      run: |
        if [ -z "$RUN_ID" ]; then
          echo "RUN_ID not found. Make sure the MLflow project ran successfully."
          exit 1
        fi

        mlflow models build-docker \
          -m runs:/$RUN_ID/model \
          -n renal4452/bank-mlflow:latest

    # =========================
    # PUSH IMAGE
    # =========================
    - name: Push Docker image
      run: |
        docker push renal4452/bank-mlflow:latest
